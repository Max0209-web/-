html
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Семейный Календарь</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #4CAF50;
            --primary-dark: #388E3C;
            --secondary: #2196F3;
            --danger: #F44336;
            --warning: #FF9800;
            --success: #4CAF50;
            --dark: #333;
            --light: #f8f9fa;
            --gray: #6c757d;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --radius: 12px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }
        
        .app-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            min-height: calc(100vh - 40px);
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 25px 20px;
            position: relative;
        }
        
        .header::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            transform: translate(30%, -30%);
        }
        
        .family-info {
            position: relative;
            z-index: 2;
        }
        
        .family-name {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .family-name i {
            font-size: 1.5rem;
            opacity: 0.9;
        }
        
        .family-code {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 25px;
        }
        
        .stat {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: var(--radius);
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        .content {
            padding: 20px;
        }
        
        .date-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 18px;
            background: var(--light);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        
        .nav-btn {
            background: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--primary);
            font-size: 1.2rem;
            box-shadow: var(--shadow);
            transition: all 0.3s;
        }
        
        .nav-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }
        
        .current-month {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            margin-bottom: 30px;
        }
        
        .day-header {
            text-align: center;
            padding: 12px 5px;
            font-weight: 600;
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .day-cell {
            aspect-ratio: 1;
            background: var(--light);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            border: 2px solid transparent;
        }
        
        .day-cell:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }
        
        .day-cell.today {
            background: linear-gradient(135deg, var(--primary) 0%, #81C784 100%);
            color: white;
            font-weight: 700;
        }
        
        .day-cell.selected {
            border-color: var(--primary);
            background: white;
            color: var(--primary);
            font-weight: 700;
        }
        
        .day-cell.has-events::after {
            content: '';
            position: absolute;
            bottom: 8px;
            width: 6px;
            height: 6px;
            background: var(--secondary);
            border-radius: 50%;
        }
        
        .day-number {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .day-events {
            font-size: 0.7rem;
            margin-top: 4px;
            background: rgba(0,0,0,0.1);
            color: var(--dark);
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .events-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .events-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .add-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: var(--shadow);
        }
        
        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .events-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .event-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--primary);
            transition: all 0.3s;
        }
        
        .event-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .event-card.important {
            border-left-color: var(--danger);
            background: linear-gradient(90deg, rgba(244,67,54,0.05) 0%, white 30%);
        }
        
        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .event-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
            flex: 1;
        }
        
        .event-time {
            background: var(--light);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary);
            white-space: nowrap;
        }
        
        .event-desc {
            color: var(--gray);
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .event-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }
        
        .event-author {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--gray);
        }
        
        .author-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--secondary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            animation: slideUp 0.4s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray);
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            background: var(--light);
            color: var(--danger);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: var(--radius);
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(76,175,80,0.1);
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .color-picker {
            display: flex;
            gap: 12px;
            margin-top: 10px;
        }
        
        .color-option {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .color-option:hover {
            transform: scale(1.1);
        }
        
        .color-option.selected {
            border-color: var(--dark);
            transform: scale(1.1);
        }
        
        .submit-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .loading {
            text-align: center;
            padding: 50px 20px;
            color: var(--gray);
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            bottom: 25px;
            right: 25px;
            background: white;
            padding: 18px 24px;
            border-radius: var(--radius);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1001;
            animation: slideIn 0.3s ease;
            border-left: 5px solid var(--primary);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification.success {
            border-left-color: var(--success);
        }
        
        .notification.error {
            border-left-color: var(--danger);
        }
        
        .notification i {
            font-size: 1.5rem;
        }
        
        .notification.success i {
            color: var(--success);
        }
        
        .notification.error i {
            color: var(--danger);
        }
        
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .app-container {
                min-height: calc(100vh - 20px);
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .family-name {
                font-size: 1.5rem;
            }
            
            .stats {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="family-info">
                <div class="family-name">
                    <i class="fas fa-home"></i>
                    <span id="familyName">Загрузка...</span>
                </div>
                <div class="family-code" id="familyCode">Код: ---</div>
                
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="totalNotes">0</div>
                        <div class="stat-label">Всего заметок</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="totalMembers">0</div>
                        <div class="stat-label">Участников</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="todayNotes">0</div>
                        <div class="stat-label">Сегодня</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="content">
            <div class="date-nav">
                <button class="nav-btn" onclick="changeMonth(-1)">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="current-month" id="currentMonth"></div>
                <button class="nav-btn" onclick="changeMonth(1)">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            
            <div class="calendar" id="calendarGrid"></div>
            
            <div class="events-header">
                <div class="events-title">
                    <i class="fas fa-calendar-day"></i>
                    <span id="selectedDateTitle">События на сегодня</span>
                </div>
                <button class="add-btn" onclick="openModal()">
                    <i class="fas fa-plus"></i>
                    Добавить
                </button>
            </div>
            
            <div class="events-list" id="eventsList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Загружаем события...</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-calendar-plus"></i>
                    Новое событие
                </div>
                <button class="close-btn" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="eventForm" onsubmit="return false;">
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-heading"></i>
                        Название события
                    </label>
                    <input type="text" class="form-input" id="eventTitle" placeholder="Что планируем?" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-align-left"></i>
                        Описание
                    </label>
                    <textarea class="form-input form-textarea" id="eventDescription" placeholder="Дополнительные детали..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-calendar-alt"></i>
                        Дата
                    </label>
                    <input type="date" class="form-input" id="eventDate" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-clock"></i>
                        Время
                    </label>
                    <input type="time" class="form-input" id="eventTime" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-palette"></i>
                        Цвет
                    </label>
                    <div class="color-picker" id="colorPicker"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="eventImportant">
                        <span>Важное событие</span>
                    </label>
                </div>
                
                <button type="submit" class="submit-btn" id="submitBtn">
                    <i class="fas fa-check"></i>
                    Добавить для всей семьи
                </button>
            </form>
        </div>
    </div>
    
    <div id="notificationContainer"></div>
    
    <script>
        // Конфигурация Supabase
        const SUPABASE_URL = 'https://ваш-project.supabase.co';
        const SUPABASE_KEY = 'ваш-anon-public-key';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const colors = [
            { name: 'Зеленый', value: '#4CAF50' },
            { name: 'Синий', value: '#2196F3' },
            { name: 'Оранжевый', value: '#FF9800' },
            { name: 'Красный', value: '#F44336' },
            { name: 'Фиолетовый', value: '#9C27B0' },
            { name: 'Бирюзовый', value: '#00BCD4' }
        ];
        
        let currentDate = new Date();
        let selectedDate = new Date();
        let selectedColor = colors[0].value;
        let familyId = null;
        let familyData = null;
        let allNotes = [];
        let realtimeSubscription = null;
        
        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            familyId = urlParams.get('family');
            
            if (!familyId) {
                showError('Не указана семья в URL');
                return;
            }
            
            await loadFamilyData();
            initColorPicker();
            setupForm();
            setDefaultFormDate();
            setupRealtime();
        }
        
        async function loadFamilyData() {
            try {
                const [familyRes, notesRes, membersRes] = await Promise.all([
                    supabase.from('families').select('*').eq('id', familyId).single(),
                    supabase.from('notes').select('*, users(full_name, avatar_color)').eq('family_id', familyId).order('note_date', { ascending: false }),
                    supabase.from('users').select('*').eq('family_id', familyId)
                ]);
                
                if (familyRes.error) throw familyRes.error;
                if (notesRes.error) throw notesRes.error;
                if (membersRes.error) throw membersRes.error;
                
                familyData = familyRes.data;
                allNotes = notesRes.data;
                
                updateUI();
                generateCalendar();
                loadEventsForDate(selectedDate);
                
            } catch (error) {
                console.error('Ошибка загрузки:', error);
                showError('Ошибка загрузки данных семьи');
            }
        }
        
        function setupRealtime() {
            if (realtimeSubscription) {
                supabase.removeChannel(realtimeSubscription);
            }
            
            realtimeSubscription = supabase
                .channel('notes-channel')
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'notes',
                        filter: `family_id=eq.${familyId}`
                    },
                    async (payload) => {
                        console.log('Изменение в реальном времени:', payload);
                        
                        if (payload.eventType === 'INSERT') {
                            allNotes.push(payload.new);
                            showNotification('Новое событие добавлено!', 'success');
                        } else if (payload.eventType === 'DELETE') {
                            allNotes = allNotes.filter(n => n.id !== payload.old.id);
                        }
                        
                        updateUI();
                        generateCalendar();
                        loadEventsForDate(selectedDate);
                    }
                )
                .subscribe();
        }
        
        function updateUI() {
            if (!familyData) return;
            
            document.getElementById('familyName').textContent = familyData.name;
            document.getElementById('familyCode').textContent = `Код: ${familyData.code}`;
            document.getElementById('totalNotes').textContent = allNotes.length;
            
            const todayStr = new Date().toISOString().split('T')[0];
            const todayNotes = allNotes.filter(n => n.note_date === todayStr);
            document.getElementById('todayNotes').textContent = todayNotes.length;
            
            const membersCount = allNotes.reduce((acc, note) => {
                if (note.user_id && !acc.includes(note.user_id)) {
                    acc.push(note.user_id);
                }
                return acc;
            }, []).length;
            
            document.getElementById('totalMembers').textContent = membersCount;
        }
        
        function initColorPicker() {
            const picker = document.getElementById('colorPicker');
            picker.innerHTML = '';
            
            colors.forEach((color, index) => {
                const colorDiv = document.createElement('div');
                colorDiv.className = 'color-option';
                colorDiv.style.background = color.value;
                colorDiv.title = color.name;
                if (index === 0) colorDiv.classList.add('selected');
                colorDiv.onclick = () => selectColor(color.value);
                picker.appendChild(colorDiv);
            });
        }
        
        function selectColor(color) {
            selectedColor = color;
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.style.background === color) {
                    opt.classList.add('selected');
                }
            });
        }
        
        function generateCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            const days = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
            days.forEach(day => {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day-header';
                dayDiv.textContent = day;
                grid.appendChild(dayDiv);
            });
            
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const today = new Date();
            
            const startDay = firstDay.getDay() || 7;
            for (let i = 1; i < startDay; i++) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'day-cell empty';
                grid.appendChild(emptyDiv);
            }
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day-cell';
                
                const cellDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                const dateStr = cellDate.toISOString().split('T')[0];
                
                if (cellDate.toDateString() === today.toDateString()) {
                    dayDiv.classList.add('today');
                }
                
                if (cellDate.toDateString() === selectedDate.toDateString()) {
                    dayDiv.classList.add('selected');
                }
                
                const dayNotes = allNotes.filter(n => n.note_date === dateStr);
                if (dayNotes.length > 0) {
                    dayDiv.classList.add('has-events');
                }
                
                dayDiv.innerHTML = `
                    <div class="day-number">${day}</div>
                    ${dayNotes.length > 0 ? 
                        `<div class="day-events">${dayNotes.length}</div>` : ''}
                `;
                
                dayDiv.onclick = () => selectDate(cellDate);
                grid.appendChild(dayDiv);
            }
            
            const monthNames = [
                'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
            ];
            
            document.getElementById('currentMonth').textContent = 
                `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
        }
        
        function selectDate(date) {
            selectedDate = date;
            updateDateTitle();
            generateCalendar();
            loadEventsForDate(date);
        }
        
        function updateDateTitle() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateStr = selectedDate.toLocaleDateString('ru-RU', options);
            document.getElementById('selectedDateTitle').textContent = `События на ${dateStr}`;
        }
        
        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            generateCalendar();
            loadEventsForDate(selectedDate);
        }
        
        function loadEventsForDate(date) {
            const list = document.getElementById('eventsList');
            const dateStr = date.toISOString().split('T')[0];
            const dayNotes = allNotes.filter(n => n.note_date === dateStr);
            
            if (dayNotes.length === 0) {
                list.innerHTML = `
                    <div class="loading">
                        <p>На этот день событий нет</p>
                        <p style="margin-top: 10px; color: var(--gray); font-size: 0.9rem;">
                            Добавьте первое событие для всей семьи!
                        </p>
                    </div>
                `;
                return;
            }
            
            dayNotes.sort((a, b) => a.note_time.localeCompare(b.note_time));
            
            let html = '';
            dayNotes.forEach(note => {
                const timeStr = note.note_time.substring(0, 5);
                const importantClass = note.is_important ? 'important' : '';
                const authorName = note.users?.full_name || 'Неизвестно';
                const authorColor = note.users?.avatar_color || '#2196F3';
                
                html += `
                    <div class="event-card ${importantClass}" style="border-left-color: ${note.color_tag || '#4CAF50'}">
                        <div class="event-header">
                            <div class="event-title">${note.title}</div>
                            <div class="event-time">${timeStr}</div>
                        </div>
                        ${note.description ? 
                            `<div class="event-desc">${note.description}</div>` : ''}
                        <div class="event-footer">
                            <div class="event-author">
                                <div class="author-avatar" style="background: ${authorColor}">
                                    ${authorName.charAt(0)}
                                </div>
                                ${authorName}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }
        
        function setupForm() {
            const form = document.getElementById('eventForm');
            const submitBtn = document.getElementById('submitBtn');
            
            form.onsubmit = async function(e) {
                e.preventDefault();
                
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Добавляем...';
                
                try {
                    const eventData = {
                        family_id: familyId,
                        user_id: null,
                        title: document.getElementById('eventTitle').value.trim(),
                        description: document.getElementById('eventDescription').value.trim(),
                        note_date: document.getElementById('eventDate').value,
                        note_time: document.getElementById('eventTime').value,
                        is_important: document.getElementById('eventImportant').checked,
                        color_tag: selectedColor
                    };
                    
                    if (!eventData.title) {
                        throw new Error('Введите название события');
                    }
                    
                    const { data, error } = await supabase
                        .from('notes')
                        .insert([eventData])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    closeModal();
                    showNotification('Событие добавлено для всей семьи!', 'success');
                    
                } catch (error) {
                    console.error('Ошибка добавления:', error);
                    showNotification('Ошибка: ' + error.message, 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-check"></i> Добавить для всей семьи';
                }
            };
        }
        
        function setDefaultFormDate() {
            document.getElementById('eventDate').value = new Date().toISOString().split('T')[0];
            
            const nextHour = new Date();
            nextHour.setHours(nextHour.getHours() + 1, 0, 0, 0);
            document.getElementById('eventTime').value = 
                nextHour.toTimeString().slice(0, 5);
        }
        
        function openModal() {
            document.getElementById('addModal').style.display = 'flex';
            document.getElementById('eventForm').reset();
            setDefaultFormDate();
        }
        
        function closeModal() {
            document.getElementById('addModal').style.display = 'none';
        }
        
        function showNotification(message, type) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        function showError(message) {
            const list = document.getElementById('eventsList');
            list.innerHTML = `
                <div class="loading">
                    <p style="color: var(--danger); font-weight: 600;">${message}</p>
                    <p style="margin-top: 10px; color: var(--gray);">
                        Проверьте ссылку или попробуйте позже
                    </p>
                </div>
            `;
        }
        
        document.addEventListener('click', function(e) {
            if (e.target.id === 'addModal') {
                closeModal();
            }
        });
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
